{{#if phone}}
  <input type="color">
{{else}}
  <div class="input-wrapper">
    <input class="color-text"
      on:input="input(event)"
      on:updown="updown(event)"
      on:wheel="updown(event)"
      style="color: {{textColor}}; background-color: {{color.rgb()}};"
      :value
      placeholder="keypress: ↑↓">
  </div>
{{/if}}

<style>
  .input-wrapper {
    --size: 2.5em;
    position: relative;
    /*margin: 10px 0;*/
    font: normal 1em "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: row;}

    .input-wrapper > * {
      border-width: 1px 1px 1px 0;
      border-style: solid;
    }
    .input-wrapper > :first-child {
      border-top-left-radius: 4px;
      border-bottom-left-radius: 4px;
      border-width: 1px;
    }
    .input-wrapper > :last-child {
      border-top-right-radius: 4px;
      border-bottom-right-radius: 4px;
    }

    .color-text {
      height: var(--size);
      padding: 0 4px;
      text-align: center;
      flex: 1 1 auto; /* width: auto; */}
    .submit-btn {
      height: var(--size);
      text-align: center;}

    .color-text_list {
      position: absolute;
      margin: 0;
      padding: 0;
      top: var(--size);
      left: 0;
      width: 100%;
      list-style: none;
      text-align: left;
      color: #111;
      background-color: #ddd;
      z-index: 10000;
    }
    .color-text_list-item {
      margin: 0;
      padding: 4px;
      height: var(--size);
      list-style: none;
    }
    .color-text_list-item.active {
      font-weight: bold;
    }
    .color-text_list-item:hover {
      background-color: aqua;
    }
    /*.color-text:focus + .color-text_list,*/
    /*.color-text_list:hover,*/
    .color-text_list.active {
      visibility: visible;
    }
</style>

<script>
  import Color from 'color'

  function caretIndex (event, color) {
    const {value, selectionStart} = event.target
    const index = value[0] === '#'
      ? Math.floor((selectionStart - 1) / 2)
      // count ',' before selectionStart
      : value.substring(0, selectionStart).replace(/[^,()]/g, '').length - 1
    return ((value[0] === '#' || color.alpha() === 1) && index === 3) || index === 4 ? -1 : index
  }

  export default {
    data () {
      return {
        phone: /iPhone|iPad|Android/.test(window.navigator.userAgent),
        color: Color('#050'),
        bgColor: '',
        models: ['hsl', 'rgb', 'hex'],
        model: 'hex',
      }
    },
    computed: {
      value: (color, model) => color.toString(model),
      textColor: (color, bgColor) => bgColor.alphaBlending(color).isDark() ? '#fff' : '#000',
    },
    methods: {
      input (event) {
        const value = event.target.value

        let color
        try {
          color = Color(value)
        } catch (error) {
          return
        }
        const format = color.model
        if (!/^#?[a-f\d]{3,4}$/i.test(value)) {
          this.set({ color, format })
        }
      },
      updown (event) {
        const {value, selectionStart, selectionEnd} = event.target
        if (selectionStart !== selectionEnd) {
          return
        }

        let color
        try {
          color = Color(value)
        } catch (error) {
          return
        }
        const index = caretIndex(event, color)
        const arrow = event.type === 'keydown'
          ? (event.key === 'ArrowUp' ? 1 : -1)
          : -event.deltaY

        if (index === -1) {
          const model = this.get('model')
          const models = this.get('models')
          let findex = (models.indexOf(model) - arrow)
          if (findex < 0) {
            findex = models.length + findex
          }
          this.set({ model: models[findex % models.length] })
        } else {
          const model = color.model
          if (index === 3) {
            // alpla
            color.alpha(color.alpha() + arrow / 100)
          } else {
            // not alpla
            const plus = arrow
            let param
            switch (model) {
              case 'hsl':
                param = color.hsl().object()
                param['hsl'[index]] += plus
                break
              case 'hsv':
                param = color.hsv().object()
                param['hsv'[index]] += plus
                break
              case 'prgb':
                param = color.rgb().object()
                param.r /= 255
                param.g /= 255
                param.b /= 255
                param['rgb'[index]] += plus / 100
                param.r *= 255
                param.g *= 255
                param.b *= 255
                break
              default:
                param = color.rgb().object()
                param['rgb'[index]] += plus
                break
            }
            color = Color(param)
          }
          this.set({ color })
          event.target.selectionStart = selectionStart
          event.target.selectionEnd = selectionStart
        }
      },
    },
    events: {
      updown (node, callback) {
        function onkeydown (event) {
          let time
          if (/Arrow(Up|Down)/.test(event.key)) {
            callback(event)
            time = setTimeout(() => {
              clearTimeout(time)
              time = setInterval(() => callback(event), 100)
            }, 300)
          }
          function onkeyup (e) {
            clearInterval(time)
            time = null
            node.removeEventListener('keyup', onkeyup, false)
          }

          node.addEventListener('keyup', onkeyup, false)
        }

        node.addEventListener('keydown', onkeydown, false)

        return {
          teardown () {
            node.removeEventListener('keydown', onkeydown, false)
          }
        }
      }
    }
  }
</script>
