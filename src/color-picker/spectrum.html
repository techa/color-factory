<div class="spectrum">
  <canvas ref:canvas class="spectrum-canvas" width={{size}} height={{size}}></canvas>
  <div ref:handle class="color-handle"></div>
</div>

<style>
  .spectrum {
    position: relative;
    cursor: crosshair;
    pointer-events: auto;
  }
</style>

<script>
  import { MousePosition } from '../mouse.js'

  export default {
    data () {
      return {
        size: 150,
        hsv: {h: 0, s: 1, v: 1}
      }
    },
    oncreate () {
      // update oncolorchange
      this.observe('hsv', (hsv) => {
        this.draw(hsv.h)
        this.setPosition()
      })

      // picker
      return new MousePosition(this.refs.canvas, {
        start: (e, position) => {
          this.setColor(position)
        },
        drag: (e, position) => {
          this.setColor(position)
        },
      })
    },
    methods: {
      setColor (position) {
        const hsv = this.get('hsv')
        hsv.s = position.percentLeft / 100
        hsv.v = (100 - position.percentTop) / 100
        this.set({ hsv })
      },
      setPosition () {
        const size = this.get('size')
        const hsv = this.get('hsv')
        this.refs.handle.style.left = size * hsv.s + 'px'
        this.refs.handle.style.top = size - (size * hsv.v) + 'px'
      },
      draw (hue = this.get('hsv').h) {
        const canvas = this.refs.canvas
        const cxt = canvas.getContext('2d')
        const [w, h] = [canvas.width, canvas.height]

        cxt.clearRect(0, 0, w, h)

        cxt.fillStyle = `hsl(${hue}, 100%, 50%)`
        cxt.fillRect(0, 0, w, h)

        const whiteGrd = cxt.createLinearGradient(0, 0, w, 0)
        whiteGrd.addColorStop(0.01, 'rgba(255, 255, 255, 1.000)')
        whiteGrd.addColorStop(0.99, 'rgba(255, 255, 255, 0.000)')

        cxt.fillStyle = whiteGrd
        cxt.fillRect(0, 0, w, h)

        const blackGrd = cxt.createLinearGradient(0, 0, 0, h)
        blackGrd.addColorStop(0.01, 'rgba(0, 0, 0, 0.000)')
        blackGrd.addColorStop(0.99, 'rgba(0, 0, 0, 1.000)')

        cxt.fillStyle = blackGrd
        cxt.fillRect(0, 0, w, h)
      }
    }
  }
</script>
