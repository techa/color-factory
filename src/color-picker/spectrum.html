<div ref:box class="spectrum">
  <canvas ref:canvas class="spectrum-canvas" width={rect.width} height={rect.height}></canvas>
  <div ref:handle class="color-handle"></div>
</div>

<style>
  .spectrum {
    position: relative;
    cursor: crosshair;
    pointer-events: auto;
  }
</style>

<script>
  import { MousePosition } from '../mouse.js'

  export default {
    data () {
      return {
        rect: {width: 0, height: 0, left: 0, top: 0},
        color: 'red',
        hsv: {h: 0, s: 1, v: 1}
      }
    },
    onstate ({ changed, current }) {
      // update oncolorchange
      if (changed.color) {
        this.draw(current.color.hue())
        this.setPosition()
      }
    },
    oncreate () {
      // get size getBoundingClientRect() / getClientRect()[0]
      // const rect = this.refs.box.getBoundingClientRect()
      const rect = {
        width: this.refs.box.clientWidth,
        height: this.refs.box.clientHeight,
      }
      this.set({rect})

      // picker
      return new MousePosition(this.refs.canvas, {
        start: (e, position) => {
          this.setColor(position)
        },
        drag: (e, position) => {
          this.setColor(position)
        },
      })
    },
    methods: {
      resize () {
        const rect = {
          width: this.refs.box.clientWidth,
          height: this.refs.box.clientHeight,
        }
        this.set({rect})
      },
      setColor (position) {
        const color = this.get().color
          .saturationv(position.percentLeft)
          .value(100 - position.percentTop)
        this.set({ color })
      },
      setPosition () {
        const {color, rect} = this.get()
        const {width, height} = rect
        this.refs.handle.style.left = width * color.saturationv() / 100 + 'px'
        this.refs.handle.style.top = height - (height * color.value() / 100) + 'px'
      },
      draw (hue = this.get().color.hue()) {
        const canvas = this.refs.canvas
        const cxt = canvas.getContext('2d')
        const [w, h] = [canvas.width, canvas.height]

        cxt.clearRect(0, 0, w, h)

        cxt.fillStyle = `hsl(${hue}, 100%, 50%)`
        cxt.fillRect(0, 0, w, h)

        const whiteGrd = cxt.createLinearGradient(0, 0, w, 0)
        whiteGrd.addColorStop(0.01, 'rgba(255, 255, 255, 1.000)')
        whiteGrd.addColorStop(0.99, 'rgba(255, 255, 255, 0.000)')

        cxt.fillStyle = whiteGrd
        cxt.fillRect(0, 0, w, h)

        const blackGrd = cxt.createLinearGradient(0, 0, 0, h)
        blackGrd.addColorStop(0.01, 'rgba(0, 0, 0, 0.000)')
        blackGrd.addColorStop(0.99, 'rgba(0, 0, 0, 1.000)')

        cxt.fillStyle = blackGrd
        cxt.fillRect(0, 0, w, h)
      }
    }
  }
</script>
