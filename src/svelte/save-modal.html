<Modal on:close="fire('close')">
  <h3 slot='header'>Save &amp; Load</h3>

  {#each list as {paletteName, palette, cardsLength} }
  <div class="listitem button-set {paletteName == $paletteName ? 'active':''}">
    <div class="name" on:click="load(paletteName)">
      {paletteName}
    </div>
    <div class="palette button-set" on:click="load(paletteName)">
      {#each palette as color}
        <div class="tip" style="background-color: {color};"></div>
      {/each}
    </div>
    <div class="color-num">
      {palette.length}
    </div>
    <div class="color-num">
      {cardsLength}
    </div>
    <div class="btns">
      <button on:click="remove(paletteName)">
        <i class="fa fa-minus-square"></i>
      </button>
    </div>
  </div>
  {/each}

  <hr>

  <div class="footer button-set">
    <div>Save as:</div>
    <input bind:value placeholder="Palette Name" style="flex: 1;">
    <button on:click="save(value)" style="background-color: {listContains?'aquamarine':'dodgerblue'};">
      {#if listContains}
        Overwrite
      {:else}
        New Save
      {/if}
      <i class="fa fa-plus-square"></i>
    </button>
  </div>
</Modal>

<style>
  .name {
    position: relative;
    width: 200px;
    flex: 3 0 200px;
  }
  input {
    border-color: silver;
    border-style: solid;
    border-width: 1px;
  }
  .listitem,
  .footer,
  .footer input,
  .footer button,
  .footer div {
    padding: 5px;
  }
  .footer button {
    margin: 0 0 0 8px;
    border-radius: 4px;
  }
  .listitem.active {
    background: aquamarine;
  }
  .listitem:hover {
    background: #9edada;
  }
  .palette {
    position: relative;
  }
  .tip {
    margin: 2px 0;
    flex: 1;
  }
  .color-num {
    width: 48px;
    text-align: right;
  }
</style>

<script>
  import Modal from './modal.html'
  import Color from '../Colorx.js'
  import defaultpalette from '../constants/newwebcolor'

  const saveKeys = Object.keys(defaultpalette)

  function colorlist (cards) {
    return cards
      .map((card) => new Color(card.color).toJSON())
      .reduce((result, card) => {
        if (!~result.indexOf(card)) {
          result.push(card)
        }
        return result
      }, [])
  }

  export default {
    components: {
      Modal
    },
    data () {
      return {
        list: [],
        value: '',
      }
    },
    computed: {
      listContains: ({list, value}) => list.some(({paletteName}) => paletteName === value),
    },
    oncreate () {
      const {paletteName} = this.store.get()
      this.set({
        value: paletteName,
        list: this.getList(),
      })
    },
    methods: {
      getList () {
        return this.store.dataList().map(({ paletteName, cards }) => {
          const palette = colorlist(cards)
          return {
            paletteName,
            palette,
            cardsLength: cards.length,
          }
        })
      },
      load (paletteName) {
        this.store.load(paletteName)
        this.root.cardsPosition()
        this.set({
          value: paletteName,
        })
      },
      remove (paletteName) {
        this.store.remove(paletteName)
        const {list} = this.get()
        list.splice(list.findIndex((item) => item.paletteName === paletteName), 1)
        this.set({list})
      },
      save (value) {
        if (!value) {
          return
        }
        this.store.set({paletteName: value})
        this.store.save(value, saveKeys)
        this.set({
          list: this.getList(),
        })
      },
    }
  }
</script>
